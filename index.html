<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ThunderNet - Control de Materiales</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <header class="bg-blue-600 text-white shadow-lg">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <i class="fas fa-tools text-2xl"></i>
            <h1 class="text-xl font-bold">
              ThunderNet - Control de Materiales
            </h1>
          </div>
        </div>
      </div>
    </header>
    <nav class="bg-white shadow-sm border-b">
      <div class="container mx-auto px-4">
        <div class="flex space-x-1 overflow-x-auto">
          <button
            class="tab-btn active px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 border-blue-500 text-blue-600"
            data-tab="dashboard"
          >
            <i class="fas fa-chart-pie mr-2"></i>Dashboard
          </button>
          <button
            class="tab-btn px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 border-transparent text-gray-500 hover:text-gray-700"
            data-tab="registro"
          >
            <i class="fas fa-plus mr-2"></i>Agregar Registro
          </button>
          <button
            class="tab-btn px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 border-transparent text-gray-500 hover:text-gray-700"
            data-tab="insumos"
          >
            <i class="fas fa-warehouse mr-2"></i>Agregar Insumos
          </button>
          <button
            class="tab-btn px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 border-transparent text-gray-500 hover:text-gray-700"
            data-tab="reportes"
          >
            <i class="fas fa-file-alt mr-2"></i>Reportes
          </button>
          <button
            class="tab-btn px-4 py-3 text-sm font-medium whitespace-nowrap border-b-2 border-transparent text-gray-500 hover:text-gray-700"
            data-tab="importar"
          >
            <i class="fas fa-upload mr-2"></i>Importar
          </button>
        </div>
      </div>
    </nav>

    <main class="container mx-auto px-4 py-6">
      <div id="dashboard" class="tab-content">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
              <div class="p-3 rounded-full bg-blue-100 text-blue-500">
                <i class="fas fa-boxes"></i>
              </div>
              <div class="ml-4">
                <p class="text-sm text-gray-500">Total Registros</p>
                <p
                  class="text-2xl font-semibold text-gray-700"
                  id="totalRegistros"
                >
                  0
                </p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
              <div class="p-3 rounded-full bg-green-100 text-green-500">
                <i class="fas fa-calendar-day"></i>
              </div>
              <div class="ml-4">
                <p class="text-sm text-gray-500">Hoy</p>
                <p
                  class="text-2xl font-semibold text-gray-700"
                  id="registrosHoy"
                >
                  0
                </p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
              <div class="p-3 rounded-full bg-yellow-100 text-yellow-500">
                <i class="fas fa-calendar-week"></i>
              </div>
              <div class="ml-4">
                <p class="text-sm text-gray-500">Esta Semana</p>
                <p
                  class="text-2xl font-semibold text-gray-700"
                  id="registrosSemana"
                >
                  0
                </p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
              <div class="p-3 rounded-full bg-purple-100 text-purple-500">
                <i class="fas fa-calendar-alt"></i>
              </div>
              <div class="ml-4">
                <p class="text-sm text-gray-500">Este Mes</p>
                <p
                  class="text-2xl font-semibold text-gray-700"
                  id="registrosMes"
                >
                  0
                </p>
              </div>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-4">Consumo por Categoría</h3>
            <div style="height: 300px">
              <canvas id="categoryChart"></canvas>
            </div>
          </div>
          <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-4">Tendencia Mensual</h3>
            <div style="height: 300px">
              <canvas id="trendChart"></canvas>
            </div>
          </div>
        </div>
        <div class="bg-white rounded-lg shadow">
          <div class="px-6 py-4 border-b border-gray-200">
            <div
              class="flex flex-col sm:flex-row sm:items-center sm:justify-between"
            >
              <h3 class="text-lg font-semibold">Registros Recientes</h3>
              <div class="mt-4 sm:mt-0 flex space-x-2">
                <input
                  type="date"
                  id="filterDate"
                  class="px-3 py-2 border border-gray-300 rounded-md text-sm"
                />
                <input
                  type="text"
                  id="filterCode"
                  placeholder="Filtrar por Cuadrilla"
                  class="px-3 py-2 border border-gray-300 rounded-md text-sm"
                />
              </div>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Cuadrilla
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Fecha
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Acopladores
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Conectores
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Fibra Drop
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Acciones
                  </th>
                </tr>
              </thead>
              <tbody
                id="registrosTableBody"
                class="bg-white divide-y divide-gray-200"
              ></tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="registro" class="tab-content hidden">
        <div class="max-w-4xl mx-auto">
          <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">
              <i class="fas fa-clipboard-list mr-2"></i>
              Registro de Materiales de Cuadrillas Integrales
            </h2>
            <form id="materialForm" class="space-y-6">
              <div
                class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg"
              >
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >CUADRILLA</label
                  >
                  <input
                    type="text"
                    id="codigo"
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Ej: AC01"
                  />
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >FECHA</label
                  >
                  <input
                    type="date"
                    id="fecha"
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
              </div>

              <div class="p-4 border-2 border-blue-200 rounded-lg">
                <h3 class="text-lg font-semibold text-blue-700 mb-3">
                  ACOPLADORES
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >ACOPLADOR APC</label
                    >
                    <input
                      type="number"
                      id="acopladorAPC"
                      min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >ACOPLADOR UPC</label
                    >
                    <input
                      type="number"
                      id="acopladorUPC"
                      min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                </div>
              </div>

              <div class="p-4 border-2 border-green-200 rounded-lg">
                <h3 class="text-lg font-semibold text-green-700 mb-3">
                  CONECTORES
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >CONECTORES APC</label
                    >
                    <input
                      type="number"
                      id="conectorAPC"
                      min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >CONECTORES UPC</label
                    >
                    <input
                      type="number"
                      id="conectorUPC"
                      min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                    />
                  </div>
                </div>
              </div>

              <div class="p-4 border-2 border-purple-200 rounded-lg">
                <h3 class="text-lg font-semibold text-purple-700 mb-3">
                  DIVISORES
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >DIVISOR 1 X 16</label
                    >
                    <input
                      type="number"
                      id="divisor1x16"
                      min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >DIVISOR 1 X 8</label
                    >
                    <input
                      type="number"
                      id="divisor1x8"
                      min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                    />
                  </div>
                </div>
              </div>

              <div class="p-4 border-2 border-yellow-200 rounded-lg">
                <h3 class="text-lg font-semibold text-yellow-700 mb-3">
                  FIBRA
                </h3>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1"
                    >FIBRA DROP 1F (Mts)</label
                  >
                  <input
                    type="number"
                    id="fibraDrop1F"
                    min="0"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500"
                  />
                </div>
              </div>

              <div class="p-4 border-2 border-red-200 rounded-lg">
                <h3 class="text-lg font-semibold text-red-700 mb-3">
                  GRAPAS, MANGUITOS Y ONU
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >GRAPAS</label
                    >
                    <input
                      type="number"
                      id="grapas"
                      min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >MANGUITO TERMICO</label
                    >
                    <input
                      type="number"
                      id="termos"
                      min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >ONU GPON</label
                    >
                    <input
                      type="number"
                      id="onu"
                      min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                    />
                  </div>
                </div>
              </div>

              <div class="p-4 border-2 border-indigo-200 rounded-lg">
                <h3 class="text-lg font-semibold text-indigo-700 mb-3">
                  PATCH CORD
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >UPC-UPC</label
                    >
                    <input
                      type="number"
                      id="ptcAA"
                      min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >PC-3M-SC-UPC-SC-APC-205</label
                    >
                    <input
                      type="number"
                      id="ptcVA"
                      min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >APC-APC</label
                    >
                    <input
                      type="number"
                      id="ptcAPC"
                      min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    />
                  </div>
                </div>
              </div>

              <div class="p-4 border-2 border-pink-200 rounded-lg">
                <h3 class="text-lg font-semibold text-pink-700 mb-3">
                  ROSETAS
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >ROSETA</label
                    >
                    <input
                      type="number"
                      id="roseta"
                      min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500"
                    />
                  </div>
                </div>
              </div>

              <div class="p-4 border-2 border-teal-200 rounded-lg">
                <h3 class="text-lg font-semibold text-teal-700 mb-3">
                  SERVILLETAS Y CINTA D.F
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >SERVILLETAS</label
                    >
                    <input
                      type="number"
                      id="servilletas"
                      min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >CINTA DOBLE FACE</label
                    >
                    <input
                      type="number"
                      id="cintaDobleFace"
                      min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500"
                    />
                  </div>
                </div>
              </div>

              <div class="p-4 border-2 border-orange-200 rounded-lg">
                <h3 class="text-lg font-semibold text-orange-700 mb-3">
                  TEIPE Y TIRRO
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >TEIPE</label
                    >
                    <input
                      type="number"
                      id="teipe"
                      min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >TIRRO</label
                    >
                    <input
                      type="number"
                      id="tirro"
                      min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                    />
                  </div>
                </div>
              </div>

              <div class="p-4 border-2 border-gray-300 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">
                  TIRRAJES
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >TIRRAJE Grande</label
                    >
                    <input
                      type="number"
                      id="tirrapG"
                      min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >TIRRAJE Mediano</label
                    >
                    <input
                      type="number"
                      id="tirrapM"
                      min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >TIRRAJE Pequeño</label
                    >
                    <input
                      type="number"
                      id="tirrapP"
                      min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500"
                    />
                  </div>
                </div>
              </div>

              <div class="flex justify-center space-x-4 pt-6">
                <button
                  type="submit"
                  class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg transition duration-200"
                >
                  <i class="fas fa-save mr-2"></i>Guardar
                </button>
                <button
                  type="button"
                  id="cancelEdit"
                  class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-lg transition duration-200"
                >
                  <i class="fas fa-times mr-2"></i>Cancelar
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div id="reportes" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-2xl font-bold mb-6">
            <i class="fas fa-chart-bar mr-2"></i>Reportes y Análisis
          </h2>

          <div class="mb-6 p-4 bg-gray-50 rounded-lg">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >Fecha Inicio</label
                >
                <input
                  type="date"
                  id="reportStartDate"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >Fecha Fin</label
                >
                <input
                  type="date"
                  id="reportEndDate"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md"
                />
              </div>
              <div class="flex items-end">
                <button
                  id="generateReport"
                  class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md"
                >
                  <i class="fas fa-chart-line mr-2"></i>Generar Reporte
                </button>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold mb-4">
                Consumo Total por Categoría
              </h3>
              <div style="height: 400px">
                <canvas id="reportCategoryChart"></canvas>
              </div>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold mb-4">Evolución Temporal</h3>
              <div style="height: 400px">
                <canvas id="reportTimeChart"></canvas>
              </div>
            </div>
          </div>

          <div class="mt-6 flex flex-wrap gap-4">
            <button
              id="exportPDF"
              class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md"
            >
              <i class="fas fa-file-pdf mr-2"></i>Exportar PDF
            </button>
            <button
              id="exportCSV"
              class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md"
            >
              <i class="fas fa-file-csv mr-2"></i>Exportar CSV
            </button>
          </div>
        </div>
      </div>

      <div id="importar" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-2xl font-bold mb-6">
            <i class="fas fa-upload mr-2"></i>Importar Datos Existentes
          </h2>
          <div class="max-w-2xl mx-auto">
            <div
              class="text-center p-8 border-2 border-dashed border-gray-300 rounded-lg mb-6"
            >
              <i
                class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"
              ></i>
              <h3 class="text-lg font-semibold text-gray-700 mb-2">
                Importar desde Google Sheets
              </h3>
              <p class="text-gray-500 mb-4">
                Copia y pega los datos de tu hoja de cálculo en el área de texto
                abajo
              </p>
              <textarea
                id="importData"
                rows="10"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4"
                placeholder="Pega aquí los datos de tu Excel...&#10;Formato esperado:&#10;CODIGO,ACOPLADOR_APC,ACOPLADOR_UPC,CONECTOR_APC,CONECTOR_UPC,DIVISOR_1X16,DIVISOR_1X8,FIBRA_DROP,GRAPAS,TERMOS,ONU,PTC_AA,PTC_VA,ROSETA,SERVILLETAS,CINTA_DOBLE_FACE,TEIPE,TIRRO,TIRRAP_G,TIRRAP_M,TIRRAP_P,FECHA"
              ></textarea>
              <button
                id="processImport"
                class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-md"
              >
                <i class="fas fa-cogs mr-2"></i>Procesar Importación
              </button>
            </div>

            <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
              <h4 class="font-semibold text-yellow-800 mb-2">
                <i class="fas fa-info-circle mr-2"></i>Ejemplo de datos
                esperados:
              </h4>
              <pre class="text-sm text-yellow-700 overflow-x-auto">
AC01,0,2,2,3,0,0,186,45,2,2,2,0,2,0,0,0,0,6,7,0,0,29/07/2025
AC01,3,0,5,0,0,0,126,18,4,3,0,3,3,3,0,0,0,6,8,0,0,28/07/2025</pre
              >
            </div>
          </div>
        </div>
      </div>
      <div id="insumos" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow p-6 max-w-4xl mx-auto">
          <h2 class="text-2xl font-bold mb-6 text-blue-700 flex items-center">
            <i class="fas fa-warehouse mr-2"></i>Agregar Insumos Semanales
          </h2>
          <form id="insumosForm" class="space-y-4 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div id="insumosInputs" class="w-full"></div>
            </div>
            <div class="flex justify-center pt-4">
              <button
                type="submit"
                class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg transition duration-200"
              >
                <i class="fas fa-plus mr-2"></i>Agregar Insumos
              </button>
            </div>
          </form>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h3 class="text-lg font-semibold mb-2 text-gray-700">
                Resumen Semanal
              </h3>
              <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-2 text-left font-medium text-gray-500">
                      Material
                    </th>
                    <th class="px-4 py-2 text-left font-medium text-gray-500">
                      Disponibles
                    </th>
                    <th class="px-4 py-2 text-left font-medium text-gray-500">
                      Gastados
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="insumosResumenBody"
                  class="bg-white divide-y divide-gray-200"
                ></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div id="messageContainer" class="fixed top-4 right-4 z-50"></div>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyCQD8cR0CDAEXKvcQLHFocUVjMDLsTfvP0",
        authDomain: "control-de-materiales-aa944.firebaseapp.com",
        projectId: "control-de-materiales-aa944",
        storageBucket: "control-de-materiales-aa944.appspot.com",
        messagingSenderId: "351278560249",
        appId: "1:351278560249:web:cb480b35a1919fa1ca0328",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const materialesCollection = db.collection("materiales");
      const insumosCollection = db.collection("insumos");

      let materialesData = [];
      let categoryChart = null;
      let trendChart = null;
      let reportCategoryChart = null;
      let reportTimeChart = null;
      let editingId = null;

      document.addEventListener("DOMContentLoaded", function () {
        initializeTabs();

        setTodayDate();
        loadMaterials();
        updateDashboard();
        initializeCharts();

        document
          .getElementById("materialForm")
          .addEventListener("submit", handleFormSubmit);
        document
          .getElementById("cancelEdit")
          .addEventListener("click", clearFormAndReturn);
        document
          .getElementById("processImport")
          .addEventListener("click", processImport);
        document
          .getElementById("generateReport")
          .addEventListener("click", generateReport);
        document
          .getElementById("exportPDF")
          .addEventListener("click", exportToPDF);
        document
          .getElementById("exportCSV")
          .addEventListener("click", exportToCSV);
        document
          .getElementById("filterDate")
          .addEventListener("change", filterData);
        document
          .getElementById("filterCode")
          .addEventListener("input", filterData);
      });

      const materialesInsumos = [
        "ACOPLADOR APC",
        "ACOPLADOR UPC",
        "CONECTOR APC",
        "CONECTOR UPC",
        "DIVISOR 1 X 16",
        "DIVISOR 1 X 8",
        "FIBRA DROP 1F",
        "GRAPAS",
        "M.TERMICO",
        "ONU GPON",
        "PATCH UPC-UPC",
        "PC-3M-SC-UPC",
        "PATCH APC-APC",
        "ROSETA",
        "SERVILLETAS",
        "CINTA D.F",
        "TEIPE",
        "TIRRO",
        "TIRRAJE Grande",
        "TIRRAJE Mediano",
        "TIRRAJE Pequeño",
      ];
      let insumosChart = null;

      function initializeTabs() {
        const tabButtons = document.querySelectorAll(".tab-btn");
        const tabContents = document.querySelectorAll(".tab-content");
        tabButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const targetTab = btn.getAttribute("data-tab");
            tabButtons.forEach((b) => {
              b.classList.remove("active", "border-blue-500", "text-blue-600");
              b.classList.add("border-transparent", "text-gray-500");
            });
            btn.classList.add("active", "border-blue-500", "text-blue-600");
            tabContents.forEach((content) => content.classList.add("hidden"));
            document.getElementById(targetTab).classList.remove("hidden");
          });
        });
      }

      function initializeTheme() {
        const themeToggle = document.getElementById("themeToggle");
        themeToggle.addEventListener("click", () => {
          document.body.classList.toggle("dark");
          const icon = themeToggle.querySelector("i");
          icon.classList.toggle("fa-moon");
          icon.classList.toggle("fa-sun");
        });
      }

      function setTodayDate() {
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("fecha").value = today;
        document.getElementById("reportEndDate").value = today;
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        document.getElementById("reportStartDate").value = thirtyDaysAgo
          .toISOString()
          .split("T")[0];
      }

      function renderInsumosInputs() {
        const container = document.getElementById("insumosInputs");
        if (!container) return;
        container.innerHTML = materialesInsumos
          .map(
            (mat) => `
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">${mat}</label>
        <input type="number" min="0" id="insumo_${mat.replace(
          /[^a-zA-Z0-9]/g,
          "_"
        )}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" value="0"/>
      </div>
    `
          )
          .join("");
      }

      document.addEventListener("DOMContentLoaded", function () {
        document
          .getElementById("insumosForm")
          ?.addEventListener("submit", handleInsumosSubmit);
        renderInsumosInputs();
        loadInsumosResumen();
      });

      function handleInsumosSubmit(e) {
        e.preventDefault();
        const semana = getCurrentWeek();

        insumosCollection
          .doc(semana)
          .get()
          .then((docSnapshot) => {
            const insumosActuales = docSnapshot.exists
              ? docSnapshot.data()
              : { semana };

            const insumosActualizados = { ...insumosActuales };

            materialesInsumos.forEach((mat) => {
              const key = mat.replace(/[^a-zA-Z0-9]/g, "_");
              const valorNuevo =
                parseInt(document.getElementById("insumo_" + key).value) || 0;
              const valorActual = insumosActuales[key] || 0;
              insumosActualizados[key] = valorActual + valorNuevo;
            });

            return insumosCollection.doc(semana).set(insumosActualizados);
          })
          .then(() => {
            showMessage(
              "Insumos agregados y sumados al total de la semana",
              "success"
            );
            loadInsumosResumen();
            document.getElementById("insumosForm").reset();
          })
          .catch((err) =>
            showMessage("Error al guardar insumos: " + err.message, "error")
          );
      }
      function getCurrentWeek() {
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), 0, 1);
        const days = Math.floor((now - firstDay) / (24 * 60 * 60 * 1000));
        const week = Math.ceil((days + firstDay.getDay() + 1) / 7);
        return `${now.getFullYear()}-S${week}`;
      }

      function loadInsumosResumen() {
        const semana = getCurrentWeek();
        insumosCollection
          .doc(semana)
          .get()
          .then((doc) => {
            const insumos = doc.exists ? doc.data() : {};

            const semanaStart = getMondayOfCurrentWeek();
            const semanaEnd = new Date(semanaStart);
            semanaEnd.setDate(semanaEnd.getDate() + 6);
            const semanaStartStr = semanaStart.toISOString().split("T")[0];
            const semanaEndStr = semanaEnd.toISOString().split("T")[0];
            const consumidos = {};
            materialesInsumos.forEach((mat) => (consumidos[mat] = 0));
            materialesData.forEach((item) => {
              if (item.fecha >= semanaStartStr && item.fecha <= semanaEndStr) {
                materialesInsumos.forEach((mat) => {
                  let key = "";
                  switch (mat) {
                    case "ACOPLADOR APC":
                      key = "acopladorAPC";
                      break;
                    case "ACOPLADOR UPC":
                      key = "acopladorUPC";
                      break;
                    case "CONECTOR APC":
                      key = "conectorAPC";
                      break;
                    case "CONECTOR UPC":
                      key = "conectorUPC";
                      break;
                    case "DIVISOR 1 X 16":
                      key = "divisor1x16";
                      break;
                    case "DIVISOR 1 X 8":
                      key = "divisor1x8";
                      break;
                    case "FIBRA DROP 1F":
                      key = "fibraDrop1F";
                      break;
                    case "GRAPAS":
                      key = "grapas";
                      break;
                    case "M.TERMICO":
                      key = "termos";
                      break;
                    case "ONU GPON":
                      key = "onu";
                      break;
                    case "PATCH UPC-UPC":
                      key = "ptcAA";
                      break;
                    case "PC-3M-SC-UPC":
                      key = "ptcVA";
                      break;
                    case "PATCH APC-APC":
                      key = "ptcAPC";
                      break;
                    case "ROSETA":
                      key = "roseta";
                      break;
                    case "SERVILLETAS":
                      key = "servilletas";
                      break;
                    case "CINTA D.F":
                      key = "cintaDobleFace";
                      break;
                    case "TEIPE":
                      key = "teipe";
                      break;
                    case "TIRRO":
                      key = "tirro";
                      break;
                    case "TIRRAJE Grande":
                      key = "tirrapG";
                      break;
                    case "TIRRAJE Mediano":
                      key = "tirrapM";
                      break;
                    case "TIRRAJE Pequeño":
                      key = "tirrapP";
                      break;
                  }
                  consumidos[mat] += item[key] || 0;
                });
              }
            });

            const tbody = document.getElementById("insumosResumenBody");
            tbody.innerHTML = "";

            tbody.innerHTML = materialesInsumos
              .map((mat) => {
                const key = mat.replace(/[^a-zA-Z0-9]/g, "_");
                return `<tr>
      <td class="px-4 py-2">${mat}</td>
      <td class="px-4 py-2">${insumos[key] || 0}</td>
      <td class="px-4 py-2">${consumidos[mat]}</td>
    </tr>`;
              })
              .join("");
          });
      }
      function getMondayOfCurrentWeek() {
        const now = new Date();
        const day = now.getDay() || 7;
        now.setHours(0, 0, 0, 0);
        if (day !== 1) now.setDate(now.getDate() - (day - 1));
        return now;
      }

      function loadMaterials() {
        materialesCollection.onSnapshot(
          (snapshot) => {
            materialesData = [];
            snapshot.forEach((doc) => {
              materialesData.push({ id: doc.id, ...doc.data() });
            });
            updateDashboard();
            updateCharts();
          },
          (error) => {
            console.error("Error al cargar materiales: ", error);
            showMessage("Error al conectar con Firebase", "error");
          }
        );
      }

      function updateDashboard() {
        const today = new Date().toISOString().split("T")[0];
        const thisWeekStart = new Date();
        thisWeekStart.setDate(thisWeekStart.getDate() - 7);
        const thisMonthStart = new Date();
        thisMonthStart.setDate(1);

        const totalRegistros = materialesData.length;
        const registrosHoy = materialesData.filter(
          (item) => item.fecha === today
        ).length;
        const registrosSemana = materialesData.filter(
          (item) => new Date(item.fecha) >= thisWeekStart
        ).length;
        const registrosMes = materialesData.filter(
          (item) => new Date(item.fecha) >= thisMonthStart
        ).length;

        document.getElementById("totalRegistros").textContent = totalRegistros;
        document.getElementById("registrosHoy").textContent = registrosHoy;
        document.getElementById("registrosSemana").textContent =
          registrosSemana;
        document.getElementById("registrosMes").textContent = registrosMes;

        updateTable();
      }

      function updateTable() {
        const tbody = document.getElementById("registrosTableBody");
        const filterDate = document.getElementById("filterDate").value;
        const filterCode = document
          .getElementById("filterCode")
          .value.toLowerCase();

        let filteredData = materialesData;
        if (filterDate) {
          filteredData = filteredData.filter(
            (item) => item.fecha === filterDate
          );
        }
        if (filterCode) {
          filteredData = filteredData.filter((item) =>
            item.codigo.toLowerCase().includes(filterCode)
          );
        }

        filteredData = filteredData.sort((a, b) => {
          if (a.fecha > b.fecha) return -1;
          if (a.fecha < b.fecha) return 1;
          return 0;
        });

        tbody.innerHTML = filteredData
          .map(
            (item) => `
          <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${
                item.codigo
              }</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${
                item.fecha
              }</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${
                (item.acopladorAPC || 0) + (item.acopladorUPC || 0)
              }</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${
                (item.conectorAPC || 0) + (item.conectorUPC || 0)
              }</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${
                item.fibraDrop1F || 0
              }</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                  <button onclick="editRecord('${
                    item.id
                  }')" class="text-blue-600 hover:text-blue-900 mr-2">
                      <i class="fas fa-edit"></i>
                  </button>
                  <button onclick="deleteRecord('${
                    item.id
                  }')" class="text-red-600 hover:text-red-900">
                      <i class="fas fa-trash"></i>
                  </button>
              </td>
          </tr>
      `
          )
          .join("");
      }

      function initializeCharts() {
        const categoryCtx = document
          .getElementById("categoryChart")
          .getContext("2d");
        const trendCtx = document.getElementById("trendChart").getContext("2d");

        const categoryData = calculateCategoryTotals();
        categoryChart = new Chart(categoryCtx, {
          type: "doughnut",
          data: {
            labels: Object.keys(categoryData),
            datasets: [
              {
                data: Object.values(categoryData),
                backgroundColor: [
                  "#3B82F6",
                  "#EF4444",
                  "#10B981",
                  "#F59E0B",
                  "#8B5CF6",
                  "#F97316",
                  "#06B6D4",
                  "#84CC16",
                ],
                borderWidth: 2,
                borderColor: "#fff",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: "bottom" } },
          },
        });

        const trendData = calculateTrendData();
        trendChart = new Chart(trendCtx, {
          type: "line",
          data: {
            labels: trendData.labels,
            datasets: [
              {
                label: "Registros por Día",
                data: trendData.values,
                borderColor: "#3B82F6",
                backgroundColor: "rgba(59, 130, 246, 0.1)",
                borderWidth: 2,
                fill: true,
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
          },
        });
      }

      function calculateCategoryTotals() {
        const totals = {
          Acopladores: 0,
          Conectores: 0,
          Divisores: 0,
          Fibra: 0,
          Otros: 0,
          "Patch Cord": 0,
          Tirrajes: 0,
          Varios: 0,
        };
        materialesData.forEach((item) => {
          totals["Acopladores"] +=
            (item.acopladorAPC || 0) + (item.acopladorUPC || 0);
          totals["Conectores"] +=
            (item.conectorAPC || 0) + (item.conectorUPC || 0);
          totals["Divisores"] +=
            (item.divisor1x16 || 0) + (item.divisor1x8 || 0);
          totals["Fibra"] += item.fibraDrop1F || 0;
          totals["Otros"] += totals["Patch Cord"] +=
            (item.ptcAA || 0) + (item.ptcVA || 0) + (item.ptcAPC || 0);

          totals["Tirrajes"] +=
            (item.tirrapG || 0) + (item.tirrapM || 0) + (item.tirrapP || 0);
          totals["Varios"] +=
            (item.roseta || 0) +
            (item.servilletas || 0) +
            (item.cintaDobleFace || 0) +
            (item.teipe || 0) +
            (item.tirro || 0);
        });
        return totals;
      }

      function calculateTrendData() {
        const dateGroups = {};
        materialesData.forEach((item) => {
          dateGroups[item.fecha] = (dateGroups[item.fecha] || 0) + 1;
        });
        const sortedDates = Object.keys(dateGroups).sort();
        const values = sortedDates.map((date) => dateGroups[date]);
        return { labels: sortedDates, values: values };
      }

      function handleFormSubmit(e) {
        e.preventDefault();
        const newRecord = {
          id: editingId || Date.now().toString(),
          codigo: document.getElementById("codigo").value,
          fecha: document.getElementById("fecha").value,
          acopladorAPC:
            parseInt(document.getElementById("acopladorAPC").value) || 0,
          acopladorUPC:
            parseInt(document.getElementById("acopladorUPC").value) || 0,
          conectorAPC:
            parseInt(document.getElementById("conectorAPC").value) || 0,
          conectorUPC:
            parseInt(document.getElementById("conectorUPC").value) || 0,
          divisor1x16:
            parseInt(document.getElementById("divisor1x16").value) || 0,
          divisor1x8:
            parseInt(document.getElementById("divisor1x8").value) || 0,
          fibraDrop1F:
            parseInt(document.getElementById("fibraDrop1F").value) || 0,
          grapas: parseInt(document.getElementById("grapas").value) || 0,
          termos: parseInt(document.getElementById("termos").value) || 0,
          onu: parseInt(document.getElementById("onu").value) || 0,
          ptcAA: parseInt(document.getElementById("ptcAA").value) || 0,
          ptcVA: parseInt(document.getElementById("ptcVA").value) || 0,
          ptcAPC: parseInt(document.getElementById("ptcAPC").value) || 0,

          roseta: parseInt(document.getElementById("roseta").value) || 0,
          servilletas:
            parseInt(document.getElementById("servilletas").value) || 0,
          cintaDobleFace:
            parseInt(document.getElementById("cintaDobleFace").value) || 0,
          teipe: parseInt(document.getElementById("teipe").value) || 0,
          tirro: parseInt(document.getElementById("tirro").value) || 0,
          tirrapG: parseInt(document.getElementById("tirrapG").value) || 0,
          tirrapM: parseInt(document.getElementById("tirrapM").value) || 0,
          tirrapP: parseInt(document.getElementById("tirrapP").value) || 0,
        };

        if (editingId) {
          materialesCollection
            .doc(editingId)
            .set(newRecord)
            .then(() => {
              editingId = null;
              clearForm();
              showMessage("Registro actualizado", "success");
              document.querySelector('[data-tab="dashboard"]').click();
            })
            .catch((error) => {
              console.error("Error al actualizar: ", error);
              showMessage("Error al actualizar: " + error.message, "error");
            });
        } else {
          materialesCollection
            .add(newRecord)
            .then((docRef) => {
              return docRef.update({ id: docRef.id });
            })
            .then(() => {
              clearForm();
              showMessage("Registro guardado exitosamente", "success");
              document.querySelector('[data-tab="dashboard"]').click();
            })
            .catch((error) => {
              console.error("Error al guardar: ", error);
              showMessage("Error al guardar: " + error.message, "error");
            });
        }
      }

      function clearFormAndReturn() {
        clearForm();
        document.querySelector('[data-tab="dashboard"]').click();
      }

      function clearForm() {
        document.getElementById("materialForm").reset();
        setTodayDate();
        editingId = null;
      }

      function updateCharts() {
        if (categoryChart) {
          const categoryData = calculateCategoryTotals();
          categoryChart.data.labels = Object.keys(categoryData);
          categoryChart.data.datasets[0].data = Object.values(categoryData);
          categoryChart.update();
        }
        if (trendChart) {
          const trendData = calculateTrendData();
          trendChart.data.labels = trendData.labels;
          trendChart.data.datasets[0].data = trendData.values;
          trendChart.update();
        }
      }

      function filterData() {
        updateTable();
      }

      function editRecord(id) {
        const record = materialesData.find((item) => item.id === id);
        if (record) {
          Object.keys(record).forEach((key) => {
            const element = document.getElementById(key);
            if (element) element.value = record[key];
          });
          editingId = id;
          document.querySelector('[data-tab="registro"]').click();
        }
      }

      function deleteRecord(id) {
        console.log("ID a eliminar:", id);
        if (confirm("¿Estás seguro de que quieres eliminar este registro?")) {
          materialesCollection
            .doc(id)
            .delete()
            .then(() => {
              showMessage("Registro eliminado exitosamente", "success");
            })
            .catch((error) => {
              console.error("Error al eliminar el registro: ", error);
              showMessage("Error al eliminar: " + error.message, "error");
            });
        }
      }

      function processImport() {
        const importData = document.getElementById("importData").value;
        if (!importData.trim()) {
          showMessage("Por favor ingresa los datos a importar", "error");
          return;
        }
        const lines = importData.trim().split("\n");
        let importedCount = 0;
        lines.forEach((line, index) => {
          const values = line.split(",");
          if (values.length >= 22) {
            const record = {
              id: Date.now().toString() + index,
              codigo: values[0] || "",
              acopladorAPC: parseInt(values[1]) || 0,
              acopladorUPC: parseInt(values[2]) || 0,
              conectorAPC: parseInt(values[3]) || 0,
              conectorUPC: parseInt(values[4]) || 0,
              divisor1x16: parseInt(values[5]) || 0,
              divisor1x8: parseInt(values[6]) || 0,
              fibraDrop1F: parseInt(values[7]) || 0,
              grapas: parseInt(values[8]) || 0,
              termos: parseInt(values[9]) || 0,
              onu: parseInt(values[10]) || 0,
              ptcAA: parseInt(values[11]) || 0,
              ptcVA: parseInt(values[12]) || 0,
              ptcAPC: parseInt(values[13]) || 0,
              roseta: parseInt(values[14]) || 0,
              servilletas: parseInt(values[15]) || 0,
              cintaDobleFace: parseInt(values[16]) || 0,
              teipe: parseInt(values[17]) || 0,
              tirro: parseInt(values[18]) || 0,
              tirrapG: parseInt(values[19]) || 0,
              tirrapM: parseInt(values[20]) || 0,
              tirrapP: parseInt(values[21]) || 0,
              fecha: formatDate(values[22]),
            };
            materialesCollection.add(record).then(() => importedCount++);
          }
        });
        setTimeout(() => {
          document.getElementById("importData").value = "";
          showMessage(`${importedCount} registros importados`, "success");
        }, 1000);
      }

      function formatDate(dateStr) {
        const parts = dateStr.split("/");
        return parts.length === 3
          ? `${parts[2]}-${parts[1]}-${parts[0]}`
          : new Date().toISOString().split("T")[0];
      }

      function generateReport() {
        const startDate = document.getElementById("reportStartDate").value;
        const endDate = document.getElementById("reportEndDate").value;
        if (!startDate || !endDate) {
          showMessage("Selecciona el rango de fechas", "error");
          return;
        }
        const filteredData = materialesData.filter(
          (item) => item.fecha >= startDate && item.fecha <= endDate
        );
        updateReportCharts(filteredData);
        showMessage("Reporte generado", "success");
      }

      function updateReportCharts(data) {
        const categoryTotals = calculateCategoryTotalsForData(data);
        if (reportCategoryChart) reportCategoryChart.destroy();
        const reportCategoryCtx = document.getElementById(
          "reportCategoryChart"
        );
        reportCategoryChart = new Chart(reportCategoryCtx, {
          type: "bar",
          data: {
            labels: Object.keys(categoryTotals),
            datasets: [
              {
                label: "Total Consumido",
                data: Object.values(categoryTotals),
                backgroundColor: "#3B82F6",
                borderColor: "#1E40AF",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
          },
        });

        const timeData = calculateTimeDataForData(data);
        if (reportTimeChart) reportTimeChart.destroy();
        const reportTimeCtx = document.getElementById("reportTimeChart");
        reportTimeChart = new Chart(reportTimeCtx, {
          type: "line",
          data: {
            labels: timeData.labels,
            datasets: [
              {
                label: "Registros por Día",
                data: timeData.values,
                borderColor: "#10B981",
                backgroundColor: "rgba(16, 185, 129, 0.1)",
                borderWidth: 2,
                fill: true,
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
          },
        });
      }

      function calculateCategoryTotalsForData(data) {
        const totals = {
          Acopladores: 0,
          Conectores: 0,
          Divisores: 0,
          Fibra: 0,
          Otros: 0,
          "Patch Cord": 0,
          Tirrajes: 0,
          Varios: 0,
        };
        data.forEach((item) => {
          totals["Acopladores"] +=
            (item.acopladorAPC || 0) + (item.acopladorUPC || 0);
          totals["Conectores"] +=
            (item.conectorAPC || 0) + (item.conectorUPC || 0);
          totals["Divisores"] +=
            (item.divisor1x16 || 0) + (item.divisor1x8 || 0);
          totals["Fibra"] += item.fibraDrop1F || 0;
          totals["Otros"] +=
            (item.grapas || 0) + (item.termos || 0) + (item.onu || 0);
          totals["Patch Cord"] +=
            (item.ptcAA || 0) + (item.ptcVA || 0) + (item.ptcAPC || 0);
          totals["Tirrajes"] +=
            (item.tirrapG || 0) + (item.tirrapM || 0) + (item.tirrapP || 0);
          totals["Varios"] +=
            (item.roseta || 0) +
            (item.servilletas || 0) +
            (item.cintaDobleFace || 0) +
            (item.teipe || 0) +
            (item.tirro || 0);
        });
        return totals;
      }

      function calculateTimeDataForData(data) {
        const dateGroups = {};
        data.forEach((item) => {
          dateGroups[item.fecha] = (dateGroups[item.fecha] || 0) + 1;
        });
        const sortedDates = Object.keys(dateGroups).sort();
        const values = sortedDates.map((date) => dateGroups[date]);
        return { labels: sortedDates, values: values };
      }

      function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(20);
        doc.text("Reporte de Materiales ThunderNet", 20, 20);
        doc.setFontSize(12);
        doc.text("Fecha: " + new Date().toLocaleDateString(), 20, 30);

        const codigoSet = new Set(materialesData.map((item) => item.codigo));
        const codigos = Array.from(codigoSet).sort();

        const materiales = [
          "ACOPLADOR APC",
          "ACOPLADOR UPC",
          "CONECTOR APC",
          "CONECTOR UPC",
          "DIVISOR 1 X 16",
          "DIVISOR 1 X 8",
          "FIBRA DROP 1F",
          "GRAPAS",
          "M.TERMICO",
          "ONU GPON",
          "PATCH UPC-UPC",
          "PC-3M-SC-UPC",
          "PATCH APC-APC",
          "ROSETA",
          "SERVILLETAS",
          "CINTA D.F",
          "TEIPE",
          "TIRRO",
          "TIRRAJE Grande",
          "TIRRAJE Mediano",
          "TIRRAJE Pequeño",
        ];

        let startY = 40;
        const marginX = 20;
        const cellWidth = 30;
        const cellHeight = 10;
        const fontSize = 9;

        doc.setFontSize(fontSize);

        doc.text("Materiales", marginX, startY);
        codigos.forEach((codigo, index) => {
          const x = marginX + (index + 1) * cellWidth;
          doc.text(codigo, x, startY);
        });

        const lineY = startY + cellHeight;
        doc.setLineWidth(0.1);
        doc.line(
          marginX,
          lineY,
          marginX + (codigos.length + 1) * cellWidth,
          lineY
        );

        materiales.forEach((material, i) => {
          const y = startY + (i + 1) * cellHeight;
          doc.text(material, marginX, y);

          codigos.forEach((codigo, j) => {
            const x = marginX + (j + 1) * cellWidth;
            const total = materialesData
              .filter((item) => item.codigo === codigo)
              .reduce((sum, item) => {
                if (material === "ACOPLADOR APC")
                  return sum + (item.acopladorAPC || 0);
                if (material === "ACOPLADOR UPC")
                  return sum + (item.acopladorUPC || 0);
                if (material === "CONECTOR APC")
                  return sum + (item.conectorAPC || 0);
                if (material === "CONECTOR UPC")
                  return sum + (item.conectorUPC || 0);
                if (material === "DIVISOR 1 X 16")
                  return sum + (item.divisor1x16 || 0);
                if (material === "DIVISOR 1 X 8")
                  return sum + (item.divisor1x8 || 0);
                if (material === "FIBRA DROP 1F")
                  return sum + (item.fibraDrop1F || 0);
                if (material === "GRAPAS") return sum + (item.grapas || 0);
                if (material === "M.TERMICO") return sum + (item.termos || 0);
                if (material === "ONU GPON") return sum + (item.onu || 0);
                if (material === "PATCH UPC-UPC")
                  return sum + (item.ptcAA || 0);
                if (material === "PC-3M-SC-UPC") return sum + (item.ptcVA || 0);
                if (material === "PATCH APC-APC")
                  return sum + (item.ptcAPC || 0);
                if (material === "ROSETA") return sum + (item.roseta || 0);
                if (material === "SERVILLETAS")
                  return sum + (item.servilletas || 0);
                if (material === "CINTA D.F")
                  return sum + (item.cintaDobleFace || 0);
                if (material === "TEIPE") return sum + (item.teipe || 0);
                if (material === "TIRRO") return sum + (item.tirro || 0);
                if (material === "TIRRAJE Grande")
                  return sum + (item.tirrapG || 0);
                if (material === "TIRRAJE Mediano")
                  return sum + (item.tirrapM || 0);
                if (material === "TIRRAJE Pequeño")
                  return sum + (item.tirrapP || 0);
                return sum;
              }, 0);

            doc.text(total.toString(), x, y);
          });
        });

        const totalPages = Math.ceil(
          ((materiales.length + 1) * cellHeight) /
            (doc.internal.pageSize.height - 20)
        );
        for (let p = 1; p < totalPages; p++) {
          doc.addPage();
          doc.setFontSize(fontSize);
          doc.text("Materiales", marginX, startY);
          codigos.forEach((codigo, index) => {
            const x = marginX + (index + 1) * cellWidth;
            doc.text(codigo, x, startY);
          });
          doc.setLineWidth(0.1);
          doc.line(
            marginX,
            startY + cellHeight,
            marginX + (codigos.length + 1) * cellWidth,
            startY + cellHeight
          );
        }

        doc.save("reporte_materiales_thundernet.pdf");
        showMessage("PDF exportado", "success");
      }

      function exportToCSV() {
        const headers = [
          "Código",
          "Fecha",
          "Acoplador APC",
          "Acoplador UPC",
          "Conector APC",
          "Conector UPC",
          "Divisor 1x16",
          "Divisor 1x8",
          "Fibra Drop 1F",
          "Grapas",
          "Termos",
          "ONU",
          "PTC AA",
          "PTC VA",
          "PTC APC",
          "Roseta",
          "Servilletas",
          "Cinta Doble Face",
          "Teipe",
          "Tirro",
          "Tirrap G",
          "Tirrap M",
          "Tirrap P",
        ];
        const csvContent = [
          headers.join(","),
          ...materialesData.map((item) =>
            [
              item.codigo,
              item.fecha,
              item.acopladorAPC,
              item.acopladorUPC,
              item.conectorAPC,
              item.conectorUPC,
              item.divisor1x16,
              item.divisor1x8,
              item.fibraDrop1F,
              item.grapas,
              item.termos,
              item.onu,
              item.ptcAA,
              item.ptcVA,
              item.ptcAPC,
              item.roseta,
              item.servilletas,
              item.cintaDobleFace,
              item.teipe,
              item.tirro,
              item.tirrapG,
              item.tirrapM,
              item.tirrapP,
            ].join(",")
          ),
        ].join("\n");
        const blob = new Blob([csvContent], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "materiales_thundernet.csv";
        a.click();
        URL.revokeObjectURL(url);
        showMessage("CSV exportado", "success");
      }

      function showMessage(message, type) {
        const container = document.getElementById("messageContainer");
        const msg = document.createElement("div");
        const bgColor = type === "success" ? "bg-green-500" : "bg-red-500";
        msg.className = `${bgColor} text-white px-4 py-2 rounded-lg shadow-lg mb-2 flex items-center`;
        msg.innerHTML = `<i class="fas fa-${
          type === "success" ? "check" : "exclamation"
        }-circle mr-2"></i>${message}`;
        container.appendChild(msg);
        setTimeout(() => msg.remove(), 3000);
      }
    </script>
  </body>
</html>
